name: Test

on: [push]

jobs:
  compiler:
    name: Test Compiler
    runs-on: ubuntu-latest
    container: ghcr.io/cucapra/calyx:latest
    steps:
      - name: Checkout Calyx latest
        working-directory: /home/calyx
        run: |
          git checkout master
          git fetch
          git pull

      - name: Checkout commit that triggered run
        uses: actions/checkout@master
        working-directory: /home
        with:
          name: cucapra/filament
          refs: ${{ github.sha }}

      - name: Configure fud
        run: |
          # Copy fud configuration
          mkdir -p $HOME/.config
          cp -r /root/.config/* $HOME/.config
          # Register Icarus
          cd /home/calyx
          fud register icarus-verilog -p "$(pwd)/calyx/fud/icarus/icarus.py"
          # Register filament relevant stages
          cd /home/filament
          fud register filament -p "$(pwd)/filament/fud/filament.py"
          fud config stages.filament.exec "$(pwd)/filament/target/debug/filament"
          fud config stages.filament.library "$(pwd)/filament"

      - name: Build Filament
        uses: actions-rs/cargo@v1
        with:
          command: build
          args: --manifest-path /home/filament/Cargo.toml

      - name: Test
        working-directory: /home/filament
        run: |
          runt -d -o fail -j 1 --max-futures 10
