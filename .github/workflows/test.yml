name: Test

on: [push]

jobs:
  hash:
    name: Get Docker Hash
    runs-on: ubuntu-latest
    outputs:
      hash: ${{ steps.hash.outputs.hash }}
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          repository: cucapra/filament
          ref: ${{ github.sha }}
      - name: Get hash
        id: hash
        run: git log -s -n 1 --pretty=format:"%H" -- Dockerfile | echo "::set-output name=hash::$(cat)"
  compiler:
    name: Test Compiler
    runs-on: ubuntu-latest
    needs: hash
    container: ghcr.io/cucapra/filament:${{ needs.hash.outputs.hash }}
    steps:
      - name: Copy fud configuration
        run: |
          mkdir -p $HOME/.config
          cp -r /root/.config/* $HOME/.config
      - name: Checkout commit that triggered run
        uses: actions/checkout@v3
        with:
          repository: cucapra/filament
          ref: ${{ github.sha }}

      - name: Build Filament
        uses: actions-rs/cargo@v1
        with:
          command: build

      - name: Original test suite
        run:
          runt -d -o fail -j 1 --max-futures 10