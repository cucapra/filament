# Justfile for Latency-Insensitive Interface Experiment

# Default simulator
sim := "iverilog"
simflags := "-g2012"
verilator_flags := "-Wall -Wno-DECLFILENAME -Wno-WIDTHTRUNC -Wno-WIDTHEXPAND"

# Source files
adder_sources := "add/fp_adder_1stage.sv add/fp_adder_2stage.sv add/fp_adder_3stage.sv add/fp_adder_4stage.sv"
mult_sources := "mul/fp_mult_1stage.sv mul/fp_mult_2stage.sv mul/fp_mult_3stage.sv mul/fp_mult_4stage.sv"
wrapper_sources := "add/fp_adder_wrapper.sv mul/fp_mult_wrapper.sv add/fp_adder_li_wrapper.sv mul/fp_mult_li_wrapper.sv"
all_sources := adder_sources + " " + mult_sources + " " + wrapper_sources

# Show available recipes
default:
    @just --list

# Run all tests (recommended for verification)
test: test-variants test-static test-dynamic
    @echo "=== All Tests Completed Successfully ==="

# Test pipeline variants for mathematical consistency
test-variants:
    #!/usr/bin/env bash
    echo "=== Testing Pipeline Variants ==="
    {{sim}} {{simflags}} -o test_variants tests/test_fp_variants.sv {{adder_sources}} {{mult_sources}}
    ./test_variants

# Test static ALU with different configurations
test-static:
    #!/usr/bin/env bash
    echo "=== Testing Static ALU ==="
    {{sim}} {{simflags}} -o test_static tests/test_static_alu.sv static_alu.sv {{all_sources}}
    ./test_static

# Test fixed dynamic ALU implementation (recommended)
test-dynamic:
    #!/usr/bin/env bash
    echo "=== Testing Fixed Dynamic ALU ==="
    {{sim}} {{simflags}} -o test_dynamic_fixed tests/test_dynamic_alu_fixed.sv dynamic_alu.sv {{all_sources}}
    ./test_dynamic_fixed

# Run custom testbench with optional parameters
# Usage: just run testbench.sv [sources] [output_name]
# Examples:
#   just run debug_test.sv
#   just run my_test.sv "dynamic/main.sv fp_*.sv"
#   just run simple_test.sv "" simple
run testbench sources="" output="":
    #!/usr/bin/env bash
    if [ -z "{{testbench}}" ]; then
        echo "Error: testbench parameter is required"
        echo "Usage: just run testbench.sv [sources] [output_name]"
        echo "Examples:"
        echo "  just run debug_test.sv"
        echo "  just run my_test.sv \"dynamic/main.sv fp_*.sv\""
        echo "  just run simple_test.sv \"\" simple"
        exit 1
    fi

    # Set default values
    output_name="{{output}}"
    if [ -z "$output_name" ]; then
        output_name=$(basename "{{testbench}}" .sv)
    fi

    source_files="{{sources}}"
    if [ -z "$source_files" ]; then
        source_files="{{all_sources}}"
    fi

    echo "=== Compiling and Running $output_name ==="
    echo "Testbench: {{testbench}}"
    echo "Sources: $source_files"
    echo "Output: $output_name"

    {{sim}} {{simflags}} -o "$output_name" "{{testbench}}" $source_files
    echo "=== Executing $output_name ==="
    ./"$output_name"

# Lint all modules using Verilator
lint:
    #!/usr/bin/env bash
    echo "=== Linting All Modules ==="
    echo "Linting static ALU with all dependencies..."
    verilator {{verilator_flags}} --lint-only --top-module Static_ALU static_alu.sv {{all_sources}} || true
    echo "Linting dynamic ALU with all dependencies..."
    verilator {{verilator_flags}} --lint-only --top-module Dynamic_ALU dynamic_alu.sv {{all_sources}} || true

# Quick syntax check using iverilog
syntax-check:
    #!/usr/bin/env bash
    echo "=== Syntax Check ==="
    echo "Checking static ALU syntax..."
    {{sim}} -t null -o /dev/null static_alu.sv {{all_sources}} || true
    echo "Checking dynamic ALU syntax..."
    {{sim}} -t null -o /dev/null dynamic_alu.sv {{all_sources}} || true

# Clean generated files
clean:
    #!/usr/bin/env bash
    echo "=== Cleaning Generated Files ==="
    rm -f test_*
    rm -f debug_*
    rm -f *.vcd *.dmp *.out
    rm -f a.out
    echo "Clean completed"

# Show detailed help information
help:
    @echo "Latency-Insensitive Interface Experiment - Just Commands"
    @echo ""
    @echo "QUICK START:"
    @echo "  just test                    # Run all tests (recommended)"
    @echo "  just run my_test.sv         # Run custom testbench"
    @echo ""
    @echo "TEST SUITES:"
    @echo "  just test-variants          # Test pipeline variant consistency (1000 tests)"
    @echo "  just test-static            # Test static ALU configurations (100 tests)"
    @echo "  just test-dynamic-fixed     # Test latency-insensitive ALU (100 tests)"
    @echo "  just test-dynamic           # Test original dynamic ALU (legacy)"
    @echo ""
    @echo "DEVELOPMENT:"
    @echo "  just run TESTBENCH [SOURCES] [OUTPUT]"
    @echo "    TESTBENCH - Path to .sv testbench file (required)"
    @echo "    SOURCES   - Space-separated source files (optional, defaults to all)"
    @echo "    OUTPUT    - Executable name (optional, defaults to testbench name)"
    @echo ""
    @echo "  Examples:"
    @echo "    just run debug_test.sv"
    @echo "    just run my_test.sv \"dynamic/main.sv fp_*.sv\""
    @echo "    just run simple_test.sv \"\" simple"
    @echo ""
    @echo "VERIFICATION:"
    @echo "  just lint                   # Verilator lint check"
    @echo "  just syntax-check           # Quick syntax verification"
    @echo "  just clean                  # Remove generated files"
    @echo ""
    @echo "For detailed testing information, see TESTING.md"

# Build all test executables (for compatibility)
build-all:
    #!/usr/bin/env bash
    echo "=== Building All Test Executables ==="
    {{sim}} {{simflags}} -o test_variants tests/test_fp_variants.sv {{adder_sources}} {{mult_sources}}
    {{sim}} {{simflags}} -o test_static tests/test_static_alu.sv static_alu.sv {{all_sources}}
    {{sim}} {{simflags}} -o test_dynamic_fixed tests/test_dynamic_alu_fixed.sv dynamic_alu.sv {{all_sources}}
    echo "All executables built successfully"

# Generate VCD for waveform analysis (requires testbench modification)
vcd testbench sources="":
    #!/usr/bin/env bash
    echo "=== Generating VCD for {{testbench}} ==="
    echo "Note: Testbench must include \$dumpfile and \$dumpvars commands"
    output_name=$(basename "{{testbench}}" .sv)
    source_files="{{sources}}"
    if [ -z "$source_files" ]; then
        source_files="{{all_sources}}"
    fi
    {{sim}} {{simflags}} -o "$output_name" "{{testbench}}" $source_files
    ./"$output_name"
    if [ -f "*.vcd" ]; then
        echo "VCD file generated: *.vcd"
    else
        echo "No VCD file found. Ensure testbench includes:"
        echo "  \$dumpfile(\"waves.vcd\");"
        echo "  \$dumpvars(0, module_name);"
    fi

# Generate dynamic ALU main module with dependencies
make-dynamic-main ADD MUL:
    ./generate_dynamic_main.sh {{ADD}} {{MUL}}

# Generate static ALU main module with dependencies
make-static-main ADD MUL:
    ./generate_static_main.sh {{ADD}} {{MUL}}
